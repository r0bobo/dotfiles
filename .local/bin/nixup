#!/usr/bin/env bash

set -euo pipefail

FLAKE="$HOME/.config/nix-mypkgs"
LOCK="$FLAKE/flake.lock"

upgrade() {
	before="$(stat -c %Y "$LOCK")"
	nix flake update --flake "$FLAKE" nixpkgs

	[[ "$(stat -c %Y "$LOCK")" = "$before" ]] && exit 0

	yadm commit \
		--message='nix: update lock' \
		--quiet \
		"$LOCK"
}

case "${1:-}" in
sync)
	nix profile upgrade nix-mypkgs
	;;
upgrade | up)
	upgrade
	;;
*)
	echo "Usage: nixup sync|upgrade" >&2
	exit 1
	;;
esac
