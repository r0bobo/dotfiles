#!/usr/bin/env bash

set -euo pipefail

BAZEL_CACHE_DIR="$HOME/.cache/bazel/_bazel_$USER"

[[ -d "$BAZEL_CACHE_DIR" ]] || exit

ws_src() {
	awk '/WORKSPACE:/ { print $2 }' "$1/README"
}

is_orphaned() {
	[[ ! -d "$(ws_src "$1")" ]]
}

is_stale() {
	ws=$1
	if [[ -f "$ws/lock" ]]; then
		age_threshold="$(date +%s -d '60 days ago')"
		mtime="$(date +%s -r "$ws/lock")"
		if [[ "$mtime" < "$age_threshold" ]]; then
			return 0
		fi
		return 1
	fi
	return 0
}

for ws in "$BAZEL_CACHE_DIR/"*; do
	[[ -r "$ws/README" ]] || continue

	src="$(ws_src "$ws")"

	if is_orphaned "$ws" || is_stale "$ws"; then
		echo -e "\033[0;31mDELETE: $ws => $src\033[0m" >&2
		chmod +w -R "$ws"
		rm -rf "$ws"
		continue
	fi

	echo -e "\033[0;33mSKIP: $ws => $src\033[0m" >&2
done
